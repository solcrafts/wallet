# Wallet Requirement Specification

This document defines the connection, authentication, and communication protocols for integrating a Wallet (e.g., Browser Extension) with the Meme Wallet Relay Server.

## 1. Connection

-   **Transport**: WebSocket (Secure WSS recommended for production).
-   **URL**: `ws://<server-host>:<port>` (e.g., `ws://localhost:8080`).
-   **Query Params**: None (Authentication is handled via handshake message).

---

## 2. Authentication (Handshake)

**Requirement**: The Wallet MUST authenticate immediately after the WebSocket connection is established (`onopen`). The server will not route any messages to an unauthenticated socket.

### 2.1 Handshake Message Format
Send a JSON message with `type: "wallet_auth"`.

```json
{
  "type": "wallet_auth",
  "payload": {
    "timestamp": 1715000000000, // Current Unix Timestamp (Milliseconds)
    "address": "0x123...",       // The Ethereum Address of the Wallet
    "publicKey": "0x..."         // Optional: Public Key
  },
  "signature": "0x..."           // Ethereum Signature (EIP-191)
}
```

### 2.2 Signing Rules
The `signature` field is generated by signing the `payload` object using the Wallet's Ethereum Private Key.

1.  **Serialize**: Convert `payload` to a JSON string.
    *   *Note*: Ensure standard serialization (e.g., `JSON.stringify(payload)`).
2.  **Sign**: Use **EIP-191** standard (`personal_sign`).
    *   `signature = sign((prefix + length + JSON.stringify(payload)), privateKey)`
    
### 2.3 Success/Failure Response
-   **Success**: Server sends `{ "type": "auth_success", "message": "Authenticated" }`.
-   **Failure**: Server sends `{ "type": "auth_error", "message": "..." }` and closes the connection.

---

## 3. Handling Incoming Requests (Sender -> Wallet)

Once authenticated, the Wallet acts as a listener for requests from Senders (DApps).

### 3.1 Request Envelope
The server forwards the inner payload from the Sender.

```json
{
  "protocol": "ed25519/v1",
  "data": {
    "nonce": 123456789,      // Unique Request ID
    "timestamp": 171500...,  // Sender timestamp
    "method": "...",         // See Supported Methods below
    "params": [ ... ]        // Method parameters
  },
  "auth": {
    "pubkey": "...",         // Sender's Ed25519 Public Key
    "signature": "..."       // Ed25519 Signature of `data`
  }
}
```

### 3.2 Supported Methods

#### `sign_transaction`
Simulate the user signing a transaction but NOT broadcasting it.

-   **Request Params**:
    ```json
    [
      {
        "to": "0xTargetAddress...",
        "value": "0", // Wei value (dec or hex string)
        "data": "0x..."
      }
    ]
    ```
-   **Expected Result**: Signed Transaction Hex String (`"0x..."`).

#### `sign_message`
Simulate the user signing a text message (EIP-191 / personal_sign).

-   **Request Params**:
    ```json
    [
      "Message content to sign"
    ]
    ```
-   **Expected Result**: Signature Hex String (`"0x..."`).

#### `send_transaction`
Simulate the user signing AND broadcasting a transaction to the blockchain.

-   **Request Params**:
    ```json
    [
      {
        "to": "0xTargetAddress...",
        "value": "0",
        "data": "0x..."
      }
    ]
    ```
-   **Expected Result**: Transaction Hash (`"0x..."`).

---

## 4. Wallet Responsibilities
1.  **Verify Sender**: (Optional but Recommended) Check `auth.signature` against `data` using `auth.pubkey`.
2.  **User Approval**: Display a UI prompt for the user to approve the `method` (e.g., confirm transaction).
3.  **Execute**: Perform the requested action.

---

## 5. Sending Responses (Wallet -> Sender)

After processing a request, the Wallet MUST send a response back to the Server to be routed to the Sender.

### 5.1 Response Format
Wrap the result in an authenticated envelope.

```json
{
  "protocol": "eth/v1",
  "data": {
    "nonce": 123456789,      // MUST match the Request Nonce
    "id": 1,                 // Optional ID
    "result": "...",         // The outcome (Signatue, TxHash, etc.)
    "error": null            // Error message if failed
  },
  "auth": {
    "address": "0xWalletAddress", // MUST match the authenticated socket address
    "signature": "0x..."          // Ethereum Signature (EIP-191) of JSON.stringify(data)
  }
}
```

### 5.2 Routing Logic
The Server uses the `nonce` to find the original Sender. **Do not modify the `nonce`**.

---

## 6. Security Checklist
-   [ ] **Timestamp Check**: Ensure server time and client time are synced (server allows +/- 30s drift).
-   [ ] **Reconnection**: If WebSocket disconnects, generate a **fresh** handshake (new timestamp) to reconnect. Do not reuse old payloads.
