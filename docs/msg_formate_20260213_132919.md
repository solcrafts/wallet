# Message Format Update (Mandatory `chainId`)

Date: 2026-02-13
Version: v1.1

## Goal

Upgrade chain information from optional to mandatory.

Scope:
- `sign_transaction`
- `send_transaction`

`sign_message` does not require `chainId`.

## Breaking Change

For transaction-type requests, `params[0].chainId` is now a **required field**.

- Previous behavior: if `chainId` was missing, the wallet fell back to the locally selected network.
- New behavior: if `chainId` is missing, the wallet must reject the request with an invalid-params error.

## Request Format (Updated)

### 1) sign_transaction

```json
{
  "protocol": "ed25519/v1",
  "data": {
    "nonce": 123456789,
    "timestamp": 1715000000000,
    "method": "sign_transaction",
    "params": [
      {
        "chainId": 56,
        "to": "0xTargetAddress...",
        "value": "0",
        "data": "0x..."
      }
    ]
  },
  "auth": {
    "pubkey": "...",
    "signature": "..."
  }
}
```

### 2) send_transaction

```json
{
  "protocol": "ed25519/v1",
  "data": {
    "nonce": 123456790,
    "timestamp": 1715000001000,
    "method": "send_transaction",
    "params": [
      {
        "chainId": 56,
        "to": "0xTargetAddress...",
        "value": "0",
        "data": "0x..."
      }
    ]
  },
  "auth": {
    "pubkey": "...",
    "signature": "..."
  }
}
```

## Validation Rules (Mandatory)

For `sign_transaction` / `send_transaction`:

1. `params[0].chainId` must exist.
2. `chainId` must be a parseable positive integer.
3. `chainId` must map to a network supported by the wallet.
4. Local-network fallback is not allowed when `chainId` is missing.

## Error Handling

For missing or invalid `chainId`:

- `code`: `-32602` (Invalid params)
- `error`: `"Missing or invalid chainId"`

Example:

```json
{
  "nonce": 123456789,
  "id": 1,
  "result": null,
  "error": "Missing or invalid chainId",
  "code": -32602
}
```

## Compatibility Notes

- Senders (DApp/Agent/Server) must upgrade request construction to always include `chainId`.
- Legacy requests without `chainId` will be rejected.

## Recommended Chain IDs

- BSC: `56`
- Ethereum: `1`
- Arbitrum One: `42161`
- Polygon: `137`

## Implementation Checklist

- [ ] Wallet: enforce `chainId` as required in transaction validation.
- [ ] Wallet: remove local-network fallback when `chainId` is missing.
- [ ] Sender: inject `chainId` into all transaction requests.
- [ ] Server: add `chainId` validation in any pre-check logic.